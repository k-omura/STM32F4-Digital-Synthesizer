/*
 * FSMC_ILI9341.h
 *
 *  Created on: Dec 8, 2021
 *      Author: k-omura
 *
 * FSMC 8bit
 */


//Header files
#include <FSMC_ILI9341.h>

static uint8_t rotationNum = 1;

//***** Functions *****//
void ILI9341_sendCommand16(uint16_t _cmd) {
	*(volatile uint16_t*) LCD_ADDR_BASE = _cmd;
}

void ILI9341_sendData16(uint16_t _data) {
	*(volatile uint16_t*) LCD_ADDR_DATA = _data;
}

void ILI9341_sendCommand8(uint8_t _cmd) {
	*(volatile uint16_t*) LCD_ADDR_BASE = (uint16_t) _cmd;
}

void ILI9341_sendData8(uint8_t _data) {
	*(volatile uint16_t*) LCD_ADDR_DATA = (uint16_t) _data;
}

void ILI9341_init(void) {
	ILI9341_sendCommand8(ILI9341_RESET); // software reset command
	HAL_Delay(100);
	ILI9341_sendCommand8(ILI9341_DISPLAY_OFF); // display off
	//------------power control------------------------------
	ILI9341_sendCommand8(ILI9341_POWER1); // power control
	ILI9341_sendData8(0x26); // GVDD = 4.75v
	ILI9341_sendCommand8(ILI9341_POWER2); // power control
	ILI9341_sendData8(0x11); // AVDD=VCIx2, VGH=VCIx7, VGL=-VCIx3
	//--------------VCOM-------------------------------------
	ILI9341_sendCommand8(ILI9341_VCOM1); // vcom control
	ILI9341_sendData8(0x35); // Set the VCOMH voltage (0x35 = 4.025v)
	ILI9341_sendData8(0x3e); // Set the VCOML voltage (0x3E = -0.950v)
	ILI9341_sendCommand8(ILI9341_VCOM2); // vcom control
	ILI9341_sendData8(0xbe);

	//------------memory access control------------------------
	ILI9341_sendCommand8(ILI9341_MAC); // memory access control
	ILI9341_sendData8(0x48);

	ILI9341_sendCommand8(ILI9341_PIXEL_FORMAT); // pixel format set
	ILI9341_sendData8(0x55); // 16bit/pixel 16bitColor

	ILI9341_sendCommand8(ILI9341_FRC);
	ILI9341_sendData8(0);
	ILI9341_sendData8(0x1F);
	//-------------ddram ----------------------------
	ILI9341_sendCommand8(ILI9341_COLUMN_ADDR); // column set
	ILI9341_sendData8(0x00); // x0_HIGH---0
	ILI9341_sendData8(0x00); // x0_LOW----0
	ILI9341_sendData8(0x00); // x1_HIGH---240
	ILI9341_sendData8(0xEF); // x1_LOW----240
	ILI9341_sendCommand8(ILI9341_PAGE_ADDR); // page address set
	ILI9341_sendData8(0x00); // y0_HIGH---0
	ILI9341_sendData8(0x00); // y0_LOW----0
	ILI9341_sendData8(0x01); // y1_HIGH---320
	ILI9341_sendData8(0x3F); // y1_LOW----320

	ILI9341_sendCommand8(ILI9341_TEARING_OFF); // tearing effect off
	//LCD_write_cmd(ILI9341_TEARING_ON); // tearing effect on
	//LCD_write_cmd(ILI9341_DISPLAY_INVERSION); // display inversion
	ILI9341_sendCommand8(ILI9341_Entry_Mode_Set); // entry mode set
	// Deep Standby Mode: OFF
	// Set the output level of gate driver G1-G320: Normal display
	// Low voltage detection: Disable
	ILI9341_sendData8(0x07);
	//-----------------display------------------------
	ILI9341_sendCommand8(ILI9341_DFC); // display function control
	//Set the scan mode in non-display area
	//Determine source/VCOM output in a non-display area in the partial display mode
	ILI9341_sendData8(0x0a);
	//Select whether the liquid crystal type is normally white type or normally black type
	//Sets the direction of scan by the gate driver in the range determined by SCN and NL
	//Select the shift direction of outputs from the source driver
	//Sets the gate driver pin arrangement in combination with the GS bit to select the optimal scan mode for the module
	//Specify the scan cycle interval of gate driver in non-display area when PTG to select interval scan
	ILI9341_sendData8(0x82);
	// Sets the number of lines to drive the LCD at an interval of 8 lines
	ILI9341_sendData8(0x27);
	ILI9341_sendData8(0x00); // clock divisor

	ILI9341_sendCommand8(ILI9341_SLEEP_OUT); // sleep out
	HAL_Delay(100);
	ILI9341_sendCommand8(ILI9341_DISPLAY_ON); // display on
	HAL_Delay(100);
	ILI9341_sendCommand8(ILI9341_GRAM); // memory write
	HAL_Delay(5);
}

void ILI9341_setRotation(uint8_t _rotate) {
	switch (_rotate) {
	case 1:
		rotationNum = 1;
		ILI9341_sendCommand8(ILI9341_MEMCONTROL);
		ILI9341_sendData8(ILI9341_MADCTL_MY | ILI9341_MADCTL_BGR);
		break;
	case 2:
		rotationNum = 2;
		ILI9341_sendCommand8(ILI9341_MEMCONTROL);
		ILI9341_sendData8(ILI9341_MADCTL_MV | ILI9341_MADCTL_BGR);
		break;
	case 3:
		rotationNum = 3;
		ILI9341_sendCommand8(ILI9341_MEMCONTROL);
		ILI9341_sendData8(ILI9341_MADCTL_MX | ILI9341_MADCTL_BGR);
		break;
	case 4:
		rotationNum = 4;
		ILI9341_sendCommand8(ILI9341_MEMCONTROL);
		ILI9341_sendData8(
				ILI9341_MADCTL_MX | ILI9341_MADCTL_MY | ILI9341_MADCTL_MV
						| ILI9341_MADCTL_BGR);
		break;
	default:
		rotationNum = 1;
		ILI9341_sendCommand8(ILI9341_MEMCONTROL);
		ILI9341_sendData8(ILI9341_MADCTL_MY | ILI9341_MADCTL_BGR);
		break;
	}
}

void ILI9341_setRect(uint16_t _x1, uint16_t _y1, uint16_t _x2, uint16_t _y2) {
	ILI9341_sendCommand8(ILI9341_COLUMN_ADDR);
	ILI9341_sendData8(_x1 >> 8);
	ILI9341_sendData8(_x1 & 0xFF);
	ILI9341_sendData8(_x2 >> 8);
	ILI9341_sendData8(_x2 & 0xFF);

	ILI9341_sendCommand8(ILI9341_PAGE_ADDR);
	ILI9341_sendData8(_y1 >> 8);
	ILI9341_sendData8(_y1 & 0xFF);
	ILI9341_sendData8(_y2 >> 8);
	ILI9341_sendData8(_y2 & 0xFF);
	ILI9341_sendCommand8(ILI9341_GRAM);
}

void ILI9341_printBitmap(uint8_t *_data) {
	if (rotationNum == 1 || rotationNum == 3) {
		ILI9341_setRect(0, 0, ILI9341_WIDTH - 1, ILI9341_HEIGHT - 1);
	} else if (rotationNum == 2 || rotationNum == 4) {
		ILI9341_setRect(0, 0, ILI9341_HEIGHT - 1, ILI9341_WIDTH - 1);
	}

	for (uint32_t i = 0; i < ILI9341_PIXEL_COUNT; i++) {
		ILI9341_sendData16(col8to16[_data[i]]);
	}
}

void ILI9341_printBitmap_split(uint8_t *_data, uint8_t _div) {
	uint16_t pixel_count = 0;
	if (rotationNum == 1 || rotationNum == 3) {
		uint16_t split_width = ILI9341_HEIGHT / ILI9341_SPLIT_NUM;
		pixel_count = ILI9341_WIDTH * split_width;
		ILI9341_setRect(0, (_div * split_width), ILI9341_WIDTH - 1, ((_div + 1) * split_width - 1));
	} else if (rotationNum == 2 || rotationNum == 4) {
		uint16_t split_width = ILI9341_WIDTH / ILI9341_SPLIT_NUM;
		pixel_count = ILI9341_HEIGHT * split_width;
		ILI9341_setRect(0, (_div * split_width), ILI9341_HEIGHT - 1, ((_div + 1) * split_width - 1));
	}

	_data = _data + (pixel_count * _div);

	for (uint32_t i = 0; i < pixel_count; i++) {
		ILI9341_sendData16(col8to16[_data[i]]);
	}
}

const uint16_t col8to16[256] = {0b0000000000000000,
	0b0000000000001010,
	0b0000000000010101,
	0b0000000000011111,
	0b0000000100100000,
	0b0000000100101010,
	0b0000000100110101,
	0b0000000100111111,
	0b0000001001000000,
	0b0000001001001010,
	0b0000001001010101,
	0b0000001001011111,
	0b0000001101100000,
	0b0000001101101010,
	0b0000001101110101,
	0b0000001101111111,
	0b0000010010000000,
	0b0000010010001010,
	0b0000010010010101,
	0b0000010010011111,
	0b0000010110100000,
	0b0000010110101010,
	0b0000010110110101,
	0b0000010110111111,
	0b0000011011000000,
	0b0000011011001010,
	0b0000011011010101,
	0b0000011011011111,
	0b0000011111100000,
	0b0000011111101010,
	0b0000011111110101,
	0b0000011111111111,
	0b0010000000000000,
	0b0010000000001010,
	0b0010000000010101,
	0b0010000000011111,
	0b0010000100100000,
	0b0010000100101010,
	0b0010000100110101,
	0b0010000100111111,
	0b0010001001000000,
	0b0010001001001010,
	0b0010001001010101,
	0b0010001001011111,
	0b0010001101100000,
	0b0010001101101010,
	0b0010001101110101,
	0b0010001101111111,
	0b0010010010000000,
	0b0010010010001010,
	0b0010010010010101,
	0b0010010010011111,
	0b0010010110100000,
	0b0010010110101010,
	0b0010010110110101,
	0b0010010110111111,
	0b0010011011000000,
	0b0010011011001010,
	0b0010011011010101,
	0b0010011011011111,
	0b0010011111100000,
	0b0010011111101010,
	0b0010011111110101,
	0b0010011111111111,
	0b0100100000000000,
	0b0100100000001010,
	0b0100100000010101,
	0b0100100000011111,
	0b0100100100100000,
	0b0100100100101010,
	0b0100100100110101,
	0b0100100100111111,
	0b0100101001000000,
	0b0100101001001010,
	0b0100101001010101,
	0b0100101001011111,
	0b0100101101100000,
	0b0100101101101010,
	0b0100101101110101,
	0b0100101101111111,
	0b0100110010000000,
	0b0100110010001010,
	0b0100110010010101,
	0b0100110010011111,
	0b0100110110100000,
	0b0100110110101010,
	0b0100110110110101,
	0b0100110110111111,
	0b0100111011000000,
	0b0100111011001010,
	0b0100111011010101,
	0b0100111011011111,
	0b0100111111100000,
	0b0100111111101010,
	0b0100111111110101,
	0b0100111111111111,
	0b0110100000000000,
	0b0110100000001010,
	0b0110100000010101,
	0b0110100000011111,
	0b0110100100100000,
	0b0110100100101010,
	0b0110100100110101,
	0b0110100100111111,
	0b0110101001000000,
	0b0110101001001010,
	0b0110101001010101,
	0b0110101001011111,
	0b0110101101100000,
	0b0110101101101010,
	0b0110101101110101,
	0b0110101101111111,
	0b0110110010000000,
	0b0110110010001010,
	0b0110110010010101,
	0b0110110010011111,
	0b0110110110100000,
	0b0110110110101010,
	0b0110110110110101,
	0b0110110110111111,
	0b0110111011000000,
	0b0110111011001010,
	0b0110111011010101,
	0b0110111011011111,
	0b0110111111100000,
	0b0110111111101010,
	0b0110111111110101,
	0b0110111111111111,
	0b1001000000000000,
	0b1001000000001010,
	0b1001000000010101,
	0b1001000000011111,
	0b1001000100100000,
	0b1001000100101010,
	0b1001000100110101,
	0b1001000100111111,
	0b1001001001000000,
	0b1001001001001010,
	0b1001001001010101,
	0b1001001001011111,
	0b1001001101100000,
	0b1001001101101010,
	0b1001001101110101,
	0b1001001101111111,
	0b1001010010000000,
	0b1001010010001010,
	0b1001010010010101,
	0b1001010010011111,
	0b1001010110100000,
	0b1001010110101010,
	0b1001010110110101,
	0b1001010110111111,
	0b1001011011000000,
	0b1001011011001010,
	0b1001011011010101,
	0b1001011011011111,
	0b1001011111100000,
	0b1001011111101010,
	0b1001011111110101,
	0b1001011111111111,
	0b1011000000000000,
	0b1011000000001010,
	0b1011000000010101,
	0b1011000000011111,
	0b1011000100100000,
	0b1011000100101010,
	0b1011000100110101,
	0b1011000100111111,
	0b1011001001000000,
	0b1011001001001010,
	0b1011001001010101,
	0b1011001001011111,
	0b1011001101100000,
	0b1011001101101010,
	0b1011001101110101,
	0b1011001101111111,
	0b1011010010000000,
	0b1011010010001010,
	0b1011010010010101,
	0b1011010010011111,
	0b1011010110100000,
	0b1011010110101010,
	0b1011010110110101,
	0b1011010110111111,
	0b1011011011000000,
	0b1011011011001010,
	0b1011011011010101,
	0b1011011011011111,
	0b1011011111100000,
	0b1011011111101010,
	0b1011011111110101,
	0b1011011111111111,
	0b1101100000000000,
	0b1101100000001010,
	0b1101100000010101,
	0b1101100000011111,
	0b1101100100100000,
	0b1101100100101010,
	0b1101100100110101,
	0b1101100100111111,
	0b1101101001000000,
	0b1101101001001010,
	0b1101101001010101,
	0b1101101001011111,
	0b1101101101100000,
	0b1101101101101010,
	0b1101101101110101,
	0b1101101101111111,
	0b1101110010000000,
	0b1101110010001010,
	0b1101110010010101,
	0b1101110010011111,
	0b1101110110100000,
	0b1101110110101010,
	0b1101110110110101,
	0b1101110110111111,
	0b1101111011000000,
	0b1101111011001010,
	0b1101111011010101,
	0b1101111011011111,
	0b1101111111100000,
	0b1101111111101010,
	0b1101111111110101,
	0b1101111111111111,
	0b1111100000000000,
	0b1111100000001010,
	0b1111100000010101,
	0b1111100000011111,
	0b1111100100100000,
	0b1111100100101010,
	0b1111100100110101,
	0b1111100100111111,
	0b1111101001000000,
	0b1111101001001010,
	0b1111101001010101,
	0b1111101001011111,
	0b1111101101100000,
	0b1111101101101010,
	0b1111101101110101,
	0b1111101101111111,
	0b1111110010000000,
	0b1111110010001010,
	0b1111110010010101,
	0b1111110010011111,
	0b1111110110100000,
	0b1111110110101010,
	0b1111110110110101,
	0b1111110110111111,
	0b1111111011000000,
	0b1111111011001010,
	0b1111111011010101,
	0b1111111011011111,
	0b1111111111100000,
	0b1111111111101010,
	0b1111111111110101,
	0b1111111111111111
};
